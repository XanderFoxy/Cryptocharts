<script>
  // Initialisierung der Panels
  const panels = [
    { id: 'tv-eth', symbol: 'BINANCE:ETHUSDT' },
    { id: 'tv-near', symbol: 'BINANCE:NEARUSDT' },
    { id: 'tv-link', symbol: 'BINANCE:LINKUSDT' },
    { id: 'tv-btc', symbol: 'BINANCE:BTCUSDT' },
  ];

  // TradingView Widgets laden
  function createTV(containerId, symbol) {
    new TradingView.widget({
      "container_id": containerId,
      "autosize": true,
      "symbol": symbol,
      "interval": "60",
      "timezone": "Europe/Berlin",
      "theme": "dark",
      "style": "1",
      "locale": "de",
      "toolbar_bg": "#0b1220",
      "allow_symbol_change": true,
      "studies": ["MACD@tv-basicstudies", "RSI@tv-basicstudies"],
      "details": false,
      "hotlist": false
    });
  }

  panels.forEach(p => createTV(p.id, p.symbol));

  const gridEl = document.getElementById('grid');
  const panelEls = Array.from(document.querySelectorAll('.panel'));

  // Helper: floating Panel zentralisieren
  function centerPanel(p) {
    const w = Math.min(window.innerWidth * 0.9, 1200);
    const h = Math.min(window.innerHeight * 0.85, 800);
    p.style.width = w + 'px';
    p.style.height = h + 'px';
    p.style.left = (window.innerWidth - w) / 2 + 'px';
    p.style.top = (window.innerHeight - h) / 2 + 'px';
    p.style.zIndex = 9999;
  }

  function resetPanel(p) {
    p.classList.remove('floating');
    p.style.position = '';
    p.style.width = '';
    p.style.height = '';
    p.style.left = '';
    p.style.top = '';
    p.style.zIndex = '';
    p.style.transform = '';
  }

  function updateDimmed() {
    const anyFloating = document.querySelector('.panel.floating');
    panelEls.forEach(p => {
      if (!anyFloating) p.classList.remove('dimmed');
      else p.classList.toggle('dimmed', !p.classList.contains('floating'));
    });
  }

  // Toggle-Logik
  document.querySelectorAll('.title').forEach(title => {
    title.addEventListener('click', () => {
      const id = title.dataset.panel;
      const panel = document.getElementById(id);

      const floatingNow = panel.classList.contains('floating');

      // Zuerst alle zurücksetzen (damit immer 4 sichtbar bleiben)
      panelEls.forEach(resetPanel);

      if (!floatingNow) {
        panel.classList.add('floating');
        panel.style.position = 'fixed';
        centerPanel(panel);
      }

      updateDimmed();
    });
  });

  // ESC schließt alle Popups
  window.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      panelEls.forEach(resetPanel);
      updateDimmed();
    }
  });

  // Automatisch zentrieren bei Resize
  window.addEventListener('resize', () => {
    const floating = document.querySelector('.panel.floating');
    if (floating) centerPanel(floating);
  });
</script>
